{% load static %}
{% load user_tags %}

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IF SADD - Gerenciar Categorias</title>

  <!-- CSS personalizado -->
  <link rel="stylesheet" type="text/css" href="{% static 'css/global.css' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'css/gerenciar.css' %}" />
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üìÇ Gerenciamento de Categorias</h1>
      <p>Crie e organize as categorias de perguntas para avalia√ß√µes</p>
    </div>

    <!-- Navega√ß√£o Breadcrumb -->
    <div class="nav-breadcrumb">
      <a href="{% url 'inicio' %}">üè† In√≠cio</a>
      <span>‚Üí</span>
      <a href="{% url 'listar_avaliacoes' %}">‚öôÔ∏è Lista de Avalia√ß√µes</a>
      <span>‚Üí</span>
      <span>üìÇ Categorias</span>
    </div>

    {% include "partials/messages.html" %}

    <div class="form-section">
      <h2>
        {% if editing %}‚úèÔ∏è Editar Categoria{% else %}üìù Criar Nova Categoria{% endif %}
      </h2>
      <form method="post">
        {% csrf_token %}
        <div class="form-row">
          <div class="form-group">
            <label for="{{ form.nome.id_for_label }}">{{ form.nome.label }}</label>
            {{ form.nome }}
            {% if form.nome.errors %}
            <div class="error-message">
              {% for error in form.nome.errors %}{{ error }}{% endfor %}
            </div>
            {% endif %}
          </div>

          <div class="form-group small">
            <label for="{{ form.ordem.id_for_label }}">{{ form.ordem.label }}</label>
            {{ form.ordem }}
            {% if form.ordem.errors %}
            <div class="error-message">
              {% for error in form.ordem.errors %}{{ error }}{% endfor %}
            </div>
            {% endif %}
          </div>
        </div>

        <div class="form-group">
          <label for="{{ form.descricao.id_for_label }}">{{ form.descricao.label }}</label>
          {{ form.descricao }}
          {% if form.descricao.errors %}
          <div class="error-message">
            {% for error in form.descricao.errors %}{{ error }}{% endfor %}
          </div>
          {% endif %}
        </div>

        <div class="form-group">
          <div class="checkbox-group">
            {{ form.ativa }}
            <label for="{{ form.ativa.id_for_label }}">{{ form.ativa.label }}</label>
          </div>
          {% if form.ativa.errors %}
          <div class="error-message">
            {% for error in form.ativa.errors %}{{ error }}{% endfor %}
          </div>
          {% endif %}
        </div>

        {% if form.non_field_errors %}
        <div class="error-message">
          {% for error in form.non_field_errors %}{{ error }}{% endfor %}
        </div>
        {% endif %}

        <button type="submit" class="btn">
          {% if editing %}üíæ Atualizar Categoria{% else %}‚ûï Criar Categoria{% endif %}
        </button>
        {% if editing %}
        <a href="{% url 'gerenciar_categorias' %}" class="btn btn-secondary">Cancelar</a>
        {% endif %}
      </form>
    </div>

    <!-- Se√ß√£o de Informa√ß√µes sobre Categorias -->
    <div class="form-section">
      <h2>‚ÑπÔ∏è Informa√ß√µes sobre Categorias</h2>
      
      <div class="info-content">
        <p><strong>üìã O que s√£o categorias?</strong></p>
        <p>As categorias organizam as perguntas da avalia√ß√£o em grupos tem√°ticos, facilitando a compreens√£o e an√°lise dos resultados.</p>
        
        <p><strong>üî¢ Como funciona o campo "Ordem"?</strong></p>
        <p>O campo ordem define a sequ√™ncia em que as categorias aparecer√£o na avalia√ß√£o. Use n√∫meros √∫nicos crescentes para organizar logicamente:</p>
        
        <div class="example-box">
          <h4>üìù Exemplo de organiza√ß√£o pedag√≥gica:</h4>
          <ul>
            <li><strong>1. Did√°tica (ordem: 1)</strong>
              <ul>
                <li>O professor explica claramente?</li>
                <li>O conte√∫do √© bem organizado?</li>
              </ul>
            </li>
            <li><strong>2. Relacionamento (ordem: 2)</strong>
              <ul>
                <li>O professor √© acess√≠vel?</li>
                <li>Demonstra interesse pelo aprendizado?</li>
              </ul>
            </li>
            <li><strong>3. Avalia√ß√£o (ordem: 3)</strong>
              <ul>
                <li>Os crit√©rios s√£o claros?</li>
                <li>O feedback √© √∫til?</li>
              </ul>
            </li>
          </ul>
        </div>
        
        <div class="info-alert">
          <strong class="alert-title">üí° Dicas importantes:</strong>
          <div class="alert-text">
            <ul>
              <li><strong>Ordem √∫nica:</strong> Cada categoria deve ter uma ordem diferente (n√£o pode repetir)</li>
              <li><strong>Come√ßa em 1:</strong> Use n√∫meros a partir de 1 (n√£o aceita 0)</li>
              <li><strong>Sugest√£o:</strong> Use intervalos de 10 (10, 20, 30...) para facilitar inser√ß√µes futuras</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    {% if not editing %}
    <div class="form-section">
      <div class="section-header">
        <h2>üìã Categorias Cadastradas ({{ categorias.count }})</h2>
      </div>
      
      <!-- Se√ß√£o de Filtros -->
      <div class="filters-section" id="filtersSection">
        <div class="filter-row">
          <div class="filter-group">
            <label for="searchCategoriaNome">Buscar por Nome:</label>
            <input type="text" 
                   id="searchCategoriaNome" 
                   placeholder="Digite o nome da categoria"
                   autocomplete="off">
          </div>
          
          <div class="filter-group">
            <label for="filterStatus">Status:</label>
            <select id="filterStatus">
              <option value="">Todos os status</option>
              <option value="ativa">Ativa</option>
              <option value="inativa">Inativa</option>
            </select>
          </div>
        </div>

        <div class="filter-row">
          <div class="filter-group">
            <button type="button" 
                    onclick="clearFilters()" 
                    class="btn btn-clear"
                    title="Limpar todos os filtros">
              üßπ Limpar Filtros
            </button>
          </div>
        </div>
      </div>

      {% if categorias %}
              <div class="table-scroll-hint">
          <small>üí° Dica: Arraste a tabela lateralmente para ver mais colunas</small>
      </div>
        <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Descri√ß√£o</th>
              <th>Ordem</th>
              <th>Status</th>
              <th>Perguntas</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            {% for categoria in categorias %}
            <tr>
              <td><strong>{{ categoria.nome }}</strong></td>
              <td>
                {% if categoria.descricao %}
                  {{ categoria.descricao|truncatechars:50 }}
                {% else %}
                  <em class="text-muted">Sem descri√ß√£o</em>
                {% endif %}
              </td>
              <td>
                <span class="counter-badge">{{ categoria.ordem }}</span>
              </td>
              <td>
                {% if categoria.ativa %}
                  <span class="status-badge status-active">‚úÖ Ativa</span>
                {% else %}
                  <span class="status-badge status-inactive">‚ùå Inativa</span>
                {% endif %}
              </td>
              <td>
                <span class="counter-badge">{{ categoria.perguntas.count }}</span>
                <small class="text-muted">pergunta{{ categoria.perguntas.count|pluralize }}</small>
              </td>
              <td>
                <div class="btn-group">
                  <a href="{% url 'editar_categoria_simples' categoria.id %}" 
                     class="btn btn-sm btn-secondary" 
                     title="Editar categoria">
                    ‚úèÔ∏è Editar
                  </a>
                  {% if categoria.perguntas.count == 0 %}
                    <form method="post" action="{% url 'excluir_categoria' categoria.id %}" 
                          class="inline-form"
                          onsubmit="return confirm('Tem certeza que deseja excluir a categoria \'{{ categoria.nome|escapejs }}\'?\n\nEsta a√ß√£o n√£o poder√° ser desfeita.')">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-danger" 
                              title="Excluir categoria">
                        üóëÔ∏è Excluir
                      </button>
                    </form>
                  {% else %}
                    <button type="button" class="btn btn-sm btn-danger disabled-state" 
                            title="N√£o √© poss√≠vel excluir esta categoria pois ela possui {{ categoria.perguntas.count }} pergunta(s) associada(s)"
                            onclick="alert('N√£o √© poss√≠vel excluir esta categoria pois ela possui {{ categoria.perguntas.count }} pergunta(s) associada(s).')">
                      üóëÔ∏è Excluir
                    </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        </div>
      {% else %}
        <div class="empty-state">
          <h3>üìÇ Nenhuma categoria cadastrada</h3>
          <p>Crie a primeira categoria para organizar as perguntas das avalia√ß√µes.</p>
        </div>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <script src="{% static 'js/gerenciar-global.js' %}"></script>
  <script>
    // Fun√ß√£o para filtrar a tabela
    function filterTable() {
      const nomeFilter = document.getElementById('searchCategoriaNome').value.toLowerCase();
      const statusFilter = document.getElementById('filterStatus').value.toLowerCase();
      
      const tableRows = document.querySelectorAll('.data-table tbody tr');
      let visibleCount = 0;

      tableRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        
        if (cells.length > 1) {
          const categoriaNome = cells[0].textContent.toLowerCase().trim();
          const categoriaStatus = cells[3].textContent.toLowerCase().trim();

          const nomeMatch = !nomeFilter || categoriaNome.includes(nomeFilter);
          const statusMatch = !statusFilter || categoriaStatus.includes(statusFilter);

          if (nomeMatch && statusMatch) {
            row.style.display = '';
            visibleCount++;
          } else {
            row.style.display = 'none';
          }
        }
      });

      // Atualiza o contador
      const sectionHeader = document.querySelector('.section-header h2');
      if (sectionHeader) {
        sectionHeader.textContent = `üìã Categorias Cadastradas (${visibleCount})`;
      }
    }

    // Fun√ß√£o para limpar filtros
    function clearFilters() {
      document.getElementById('searchCategoriaNome').value = '';
      document.getElementById('filterStatus').value = '';
      filterTable();
    }

    // Adicionar event listeners para filtros
    document.addEventListener('DOMContentLoaded', function() {
      const searchCategoriaNome = document.getElementById('searchCategoriaNome');
      const filterStatus = document.getElementById('filterStatus');

      if (searchCategoriaNome) searchCategoriaNome.addEventListener('input', filterTable);
      if (filterStatus) filterStatus.addEventListener('change', filterTable);
      
      console.log("P√°gina de categorias carregada com filtros funcionais");
    });
  </script>
</body>
</html>
