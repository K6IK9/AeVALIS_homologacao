{% load static %}

<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IF SADD - Relat√≥rios de Avalia√ß√µes</title>

    <!-- CSS Global -->
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    <!-- CSS de Gerenciamento -->
    <link rel="stylesheet" href="{% static 'css/gerenciar.css' %}">
    <!-- CSS espec√≠fico do relat√≥rio -->
    <link rel="stylesheet" href="{% static 'css/relatorio_avaliacoes.css' %}">
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìä Relat√≥rios de Avalia√ß√µes</h1>
            <p>Visualize e analise os dados das avalia√ß√µes docentes</p>
        </div>

        <!-- Navega√ß√£o Breadcrumb -->
        <div class="nav-breadcrumb">
            <a href="{% url 'inicio' %}">üè† In√≠cio</a>
            <span>‚Üí</span>
            <span>üìä Relat√≥rios</span>
        </div>

        <!-- Mensagens -->
        {% include "partials/messages.html" %}

        <!-- Se√ß√£o de Filtros -->
        <div class="form-section">
            <h2>üîç Filtros de Relat√≥rio</h2>
            <form method="get" id="form-filtros">
                <div class="form-row">
                    <div class="form-group">
                        <label for="ciclo">Ciclo de Avalia√ß√£o</label>
                        <select name="ciclo" id="ciclo" class="form-control">
                            <option value="">Todos os ciclos</option>
                            {% for ciclo in ciclos %}
                            <option value="{{ ciclo.id }}" 
                                    {% if ciclo_selecionado == ciclo.id|stringformat:'s' %}selected{% endif %}>
                                {{ ciclo.nome }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="professor">Professor</label>
                        <select name="professor" id="professor" class="form-control">
                            <option value="">Todos os professores</option>
                            {% for prof in professores %}
                            <option value="{{ prof.id }}" 
                                    {% if professor_selecionado == prof.id|stringformat:'s' %}selected{% endif %}>
                                {{ prof.user.get_full_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <button type="submit" class="btn">
                            üîç Filtrar Relat√≥rio
                        </button>
                        <a href="javascript:void(0);" onclick="exportarCSV()" class="btn btn-secondary">
                            üì• Exportar CSV
                        </a>
                    </div>
                </div>
            </form>
        </div>

        <!-- Conte√∫do principal -->
        {% if avaliacoes %}
        <div class="form-section">
            <h2>üìà Relat√≥rios de Avalia√ß√£o</h2>
            <div class="item-count">
                Total de avalia√ß√µes encontradas: {{ avaliacoes|length }}
            </div>
            
            <div class="avaliacoes-grid">
                    {% for avaliacao in avaliacoes %}
                    <div class="avaliacao-card">
                        <div class="card-header">
                            <h4 class="card-title">{{ avaliacao.turma.disciplina.disciplina_nome }}</h4>
                            <div class="card-subtitle">
                                <i class="bi bi-person-fill"></i>
                                {{ avaliacao.professor.user.get_full_name }}
                            </div>
                        </div>
                        
                        <div class="card-info">
                            <div class="info-item">
                                <span>Turma:</span>
                                <strong>{{ avaliacao.turma.codigo_turma }}</strong>
                            </div>
                            <div class="info-item">
                                <span>Per√≠odo:</span>
                                <strong>{{ avaliacao.turma.periodo_letivo.nome }}</strong>
                            </div>
                            <div class="info-item">
                                <span>Alunos:</span>
                                <strong>{{ avaliacao.total_alunos }}</strong>
                            </div>
                            <div class="info-item">
                                <span>Respondentes:</span>
                                <strong>{{ avaliacao.respondentes }}</strong>
                            </div>
                            <div class="info-item">
                                <span>Taxa de Resposta:</span>
                                <strong>{{ avaliacao.taxa_resposta }}%</strong>
                            </div>
                        </div>

                        <!-- Estat√≠sticas por pergunta -->
                        {% for pergunta_stat in avaliacao.pergunta_stats %}
                        <div class="pergunta-stats">
                            <div class="pergunta-title">{{ pergunta_stat.pergunta.enunciado }}</div>
                            <div class="stats-row">
                                <div class="stat-item">
                                    <div class="stat-value">{{ pergunta_stat.media|floatformat:1 }}</div>
                                    <div class="stat-label">M√©dia</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">{{ pergunta_stat.moda }}</div>
                                    <div class="stat-label">Moda</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">{{ pergunta_stat.respostas_count }}</div>
                                    <div class="stat-label">Respostas</div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}

                        <!-- Coment√°rios -->
                        {% if avaliacao.comentarios %}
                        <div class="comentarios-section">
                            <div class="comentarios-title">
                                <i class="bi bi-chat-dots"></i> Coment√°rios ({{ avaliacao.comentarios|length }})
                            </div>
                            {% for comentario in avaliacao.comentarios %}
                            <div class="comentario-card">
                                <div class="comentario-header">
                                    <span class="comentario-aluno">Avalia√ß√£o An√¥nima</span>
                                    <span class="comentario-data">{{ comentario.data_resposta|date:"d/m/Y H:i" }}</span>
                                </div>
                                <div class="comentario-texto">{{ comentario.valor_texto }}</div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <!-- M√©tricas Gerais -->
                {% if metricas_gerais %}
                <div class="metricas-container">
                    <h3 class="metricas-title">
                        <i class="bi bi-bar-chart"></i> M√©tricas Gerais
                    </h3>
                    <div class="metricas-grid">
                        {% for media in metricas_gerais %}
                        <div class="metric-card">
                            <div class="metric-value {% if media.media >= 4 %}success{% elif media.media >= 3 %}warning{% else %}danger{% endif %}">
                                {{ media.media|floatformat:1 }}
                            </div>
                            <small class="metric-label">M√©dia</small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        {% else %}
        <div class="form-section">
            <div class="empty-state">
                <h3>üìä Nenhuma avalia√ß√£o encontrada</h3>
                <p>N√£o h√° dados de avalia√ß√£o para os filtros selecionados.</p>
                <p>Tente ajustar os filtros ou aguarde a conclus√£o de avalia√ß√µes pelos alunos.</p>
            </div>
        </div>
        {% endif %}
    </div>

    <script>
    // ================= Gr√°ficos por Ciclo =================
    const ciclosGraficos = JSON.parse('{{ ciclos_graficos_json|escapejs }}');

    function gerarCor(index, total){
        const hue = Math.round((360/Math.max(total,1))*index);
        return `hsl(${hue},65%,55%)`;
    }

    function montarContainerGraficos(){
        if(!ciclosGraficos.length) return;
        const wrapper = document.createElement('div');
        wrapper.style.marginTop = '50px';
        wrapper.innerHTML = `<h2 style="color: var(--cor03); margin-bottom:25px; display:flex; align-items:center; gap:10px;">üìä Gr√°ficos por Ciclo</h2>`;

        ciclosGraficos.forEach(ciclo => {
            const cicloDiv = document.createElement('div');
            cicloDiv.style.marginBottom = '40px';
            cicloDiv.innerHTML = `<h4 style="color: var(--cor03); margin-bottom:15px;">üåÄ ${ciclo.nome}</h4>`;

            const grade = document.createElement('div');
            grade.style.display = 'grid';
            grade.style.gridTemplateColumns = 'repeat(auto-fit,minmax(320px,1fr))';
            grade.style.gap = '25px';

            ciclo.perguntas.forEach((p, idx) => {
                const card = document.createElement('div');
                card.style.background = 'var(--cor07)';
                card.style.padding = '18px';
                card.style.borderRadius = '15px';
                card.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
                card.style.borderTop = '4px solid var(--cor02)';

                const canvasId = `chart_c${ciclo.id}_p${p.id}`;
                card.innerHTML = `
                    <div style="font-weight:600; font-size:0.9rem; color: var(--cor03); min-height:48px; margin-bottom:10px;">${p.enunciado}</div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                        <small style="color:#555; font-weight:600;">Tipo: ${p.tipo.toUpperCase()}</small>
                        <small style="color:#222; font-weight:600;">M√©dia: ${p.media}</small>
                    </div>
                    <canvas id="${canvasId}" height="180"></canvas>`;
                grade.appendChild(card);
                cicloDiv.appendChild(grade);

                setTimeout(()=>criarGrafico(canvasId, p), 0);
            });

            wrapper.appendChild(cicloDiv);
        });
        document.querySelector('.form-section').appendChild(wrapper);
    }

    function criarGrafico(canvasId, pergunta){
        const ctx = document.getElementById(canvasId);
        if(!ctx) return;
        
        let labels = Object.keys(pergunta.contagens);
        const dados = labels.map(k => pergunta.contagens[k]);
        const cores = labels.map((_,i)=>gerarCor(i, labels.length));
        
        // Definir tipo de gr√°fico e configura√ß√µes baseado no tipo da pergunta
        let tipoGrafico = 'bar';
        let datasetCfg = {
            label: 'Quantidade',
            data: dados,
            backgroundColor: cores,
            borderColor: cores,
            borderWidth: 2
        };
        
        // Configura√ß√µes espec√≠ficas por tipo de pergunta
        switch(pergunta.tipo) {
            case 'nps':
                // Para NPS, ordenar numericamente e usar gr√°fico de linha
                labels = labels.sort((a,b)=>Number(a)-Number(b));
                tipoGrafico = 'line';
                datasetCfg = {
                    label: 'Quantidade',
                    data: labels.map(k => pergunta.contagens[k]),
                    backgroundColor: 'rgba(0,253,148,0.4)',
                    borderColor: 'var(--cor02)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                };
                break;
                
            case 'likert':
                // Para Likert, ordenar numericamente
                labels = labels.sort((a,b)=>Number(a)-Number(b));
                break;
                
            case 'sim_nao':
                // Para Sim/N√£o, usar gr√°fico de rosca
                tipoGrafico = 'doughnut';
                datasetCfg = {
                    data: dados,
                    backgroundColor: ['#28a745', '#dc3545'],
                    borderWidth: 2
                };
                break;
                
            case 'multipla_escolha':
                // Para m√∫ltipla escolha, usar gr√°fico de barras horizontais
                tipoGrafico = 'bar';
                datasetCfg.backgroundColor = cores;
                break;
                
            case 'texto_livre':
                // Para texto livre, usar gr√°fico de barras simples
                tipoGrafico = 'bar';
                datasetCfg.backgroundColor = ['#17a2b8'];
                break;
        }
        
        // Configura√ß√µes espec√≠ficas para escalas
        let scalesConfig = {
            y: {
                beginAtZero: true,
                title: { display: true, text: 'Quantidade' },
                ticks: { precision: 0 }
            }
        };
        
        // Para gr√°ficos de rosca, n√£o mostrar escalas
        if (tipoGrafico === 'doughnut') {
            scalesConfig = {};
        } else {
            scalesConfig.x = {
                title: { display: true, text: pergunta.tipo === 'multipla_escolha' ? 'Op√ß√µes' : 'Valores' },
                ticks: { 
                    font: { size: 11 },
                    maxRotation: 45 
                }
            };
        }
        
        new Chart(ctx, {
            type: tipoGrafico,
            data: { labels: labels, datasets: [datasetCfg] },
            options: {
                responsive: true,
                plugins: {
                    legend: { 
                        display: tipoGrafico === 'doughnut',
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                if (tipoGrafico === 'doughnut') {
                                    return `${ctx.label}: ${ctx.parsed}`;
                                }
                                return `${ctx.label}: ${ctx.parsed.y}`;
                            }
                        }
                    }
                },
                scales: scalesConfig
            }
        });
    }

    document.addEventListener('DOMContentLoaded', montarContainerGraficos);

    function exportarCSV() {
        // Criar URL com par√¢metros atuais
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('formato', 'csv');
        
        // Redirecionar para download
        window.location.href = '{% url "relatorio_avaliacoes" %}?' + urlParams.toString();
    }

    // Auto-submit do formul√°rio quando filtros mudarem
    document.getElementById('ciclo').addEventListener('change', function() {
        document.getElementById('form-filtros').submit();
    });

    document.getElementById('professor').addEventListener('change', function() {
        document.getElementById('form-filtros').submit();
    });
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</body>
</html>
