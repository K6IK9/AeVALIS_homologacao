{% load static %}

<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Perguntas - {{ questionario.titulo }} - IF SADD</title>

    <!-- CSS Global -->
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    <!-- CSS de Gerenciamento -->
    <link rel="stylesheet" href="{% static 'css/gerenciar.css' %}">
    <!-- CSS espec√≠fico desta p√°gina -->
    <link rel="stylesheet" href="{% static 'css/editar_questionario.css' %}">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css" rel="stylesheet">
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Gerenciamento de Perguntas</h1>
            <p>Editar perguntas do question√°rio: {{ questionario.titulo }}</p>
        </div>

        <!-- Navega√ß√£o Breadcrumb -->
        <div class="nav-breadcrumb">
            <a href="{% url 'inicio' %}">üè† In√≠cio</a>
            <span>‚Üí</span>
            <a href="{% url 'gerenciar_questionarios' %}">üìù Question√°rios</a>
            <span>‚Üí</span>
            <span>Editar Perguntas</span>
        </div>

        <!-- Mensagens -->
        {% include "partials/messages.html" %}

        <div class="admin-card card-white-bg">
            <!-- Formul√°rio de Nova/Editar Pergunta -->
            <div class="form-section">
            <h2>
                {% if editando %}Editar Pergunta{% else %}Criar Nova Pergunta{% endif %}
            </h2>

            <form method="post" class="question-form">
                {% csrf_token %}
                {% if editando %}
                    <input type="hidden" name="pergunta_id" value="{{ pergunta_editando.id }}">
                {% endif %}

                {% if form.errors %}
                <div class="error-message">
                    <strong>Erros no formul√°rio:</strong>
                    {{ form.errors }}
                </div>
                {% endif %}

                <div class="form-group">
                    <label for="{{ form.enunciado.id_for_label }}">
                        Enunciado da Pergunta
                    </label>
                    {{ form.enunciado }}
                    {% if form.enunciado.errors %}
                    <div class="form-error">
                        {% for error in form.enunciado.errors %}
                        <small>{{ error }}</small>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.tipo.id_for_label }}">
                        Tipo de Pergunta
                    </label>
                    {{ form.tipo }}
                    {% if form.tipo.errors %}
                    <div class="form-error">
                        {% for error in form.tipo.errors %}
                        <small>{{ error }}</small>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <div class="form-group" id="opcoes-container" style="display: none;">
                    <label for="{{ form.opcoes_multipla_escolha.id_for_label }}">Op√ß√µes de Resposta</label>
                    {{ form.opcoes_multipla_escolha }}
                    <small class="form-help">Digite uma op√ß√£o por linha</small>
                    {% if form.opcoes_multipla_escolha.errors %}
                    <div class="form-error">
                        {% for error in form.opcoes_multipla_escolha.errors %}
                        <small>{{ error }}</small>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.categoria.id_for_label }}">
                        Categoria da Pergunta
                    </label>
                    {{ form.categoria }}
                    {% if form.categoria.errors %}
                    <div class="form-error">
                        {% for error in form.categoria.errors %}
                        <small>{{ error }}</small>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        {{ form.obrigatoria }}
                        <label for="{{ form.obrigatoria.id_for_label }}">Pergunta obrigat√≥ria</label>
                    </div>
                </div>

                {% if form.non_field_errors %}
                <div class="error-text-bottom">
                    {% for error in form.non_field_errors %}
                    {{ error }}
                    {% endfor %}
                </div>
                {% endif %}

                <div class="form-actions">
                    {% if editando %}
                    <button type="submit" name="salvar_edicao" class="btn btn-success">
                        Salvar Altera√ß√µes
                    </button>
                    <a href="{% url 'editar_questionario_perguntas' questionario.id %}" class="btn btn-secondary">
                        Cancelar
                    </a>
                    {% else %}
                    <button type="submit" name="adicionar_pergunta" class="btn btn-success">
                        Adicionar Pergunta
                    </button>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

        <!-- Filtros e Busca -->
        {% if not editando %}
        <div class="filters-section">
            <h3 class="filters-title">Filtros e Busca</h3>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="searchPerguntaTexto">Buscar por Texto:</label>
                    <div class="search-box">
                        <input type="text" id="searchPerguntaTexto" class="form-control"
                            placeholder="Digite parte do enunciado da pergunta..." autocomplete="off">
                    </div>
                </div>
                <div class="filter-group">
                    <label for="filterTipo">Filtrar por Tipo:</label>
                    <select id="filterTipo" class="form-control">
                        <option value="">Todos os tipos</option>
                        <option value="multipla_escolha">M√∫ltipla Escolha</option>
                        <option value="texto">Texto Livre</option>
                        <option value="escala">Escala de Avalia√ß√£o</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterObrigatoria">Filtrar por Obrigat√≥ria:</label>
                    <select id="filterObrigatoria" class="form-control">
                        <option value="">Todas</option>
                        <option value="sim">Obrigat√≥rias</option>
                        <option value="nao">Opcionais</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button type="button" class="btn-filter" onclick="clearFilters()">Limpar Filtros</button>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="admin-card card-white-bg">
            <!-- Lista de Perguntas -->
            <div class="form-section">
            <h2>üìã Perguntas do Question√°rio</h2>

            <div class="item-count">
                Total de perguntas: <span id="total-count">{{ perguntas_existentes.count }}</span>
            </div>

            {% if perguntas_existentes %}
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="text-align: center; width: 80px;">Ordem</th>
                        <th>Enunciado</th>
                        <th>Tipo</th>
                        <th>Categoria</th>
                        <th>Obrigat√≥ria</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for qp in perguntas_existentes %}
                        <td style="text-align: center;">
                            <span class="category-order-number">{{ qp.ordem_no_questionario }}</span>
                        </td>
                        <td>
                            <strong>{{ qp.pergunta.enunciado|truncatechars:80 }}</strong>
                            {% if qp.pergunta.opcoes_multipla_escolha %}
                            <div class="question-options-preview">
                                <small class="text-muted">
                                    Op√ß√µes:
                                    {% for opcao in qp.pergunta.opcoes_multipla_escolha|slice:":3" %}
                                    {{ opcao }}{% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                    {% if qp.pergunta.opcoes_multipla_escolha|length > 3 %}...{% endif %}
                                </small>
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            {% if qp.pergunta.tipo == 'multipla_escolha' %}
                            <span class="badge type-multiple">üìã M√∫ltipla Escolha</span>
                            {% elif qp.pergunta.tipo == 'texto_livre' %}
                            <span class="badge type-text">üìù Texto Livre</span>
                            {% elif qp.pergunta.tipo == 'likert' %}
                            <span class="badge type-scale">üìä Escala Likert</span>
                            {% elif qp.pergunta.tipo == 'nps' %}
                            <span class="badge type-nps">‚≠ê NPS (0-10)</span>
                            {% elif qp.pergunta.tipo == 'sim_nao' %}
                            <span class="badge type-binary">‚òëÔ∏è Sim/N√£o</span>
                            {% else %}
                            <span class="badge type-other">‚ùì {{ qp.pergunta.get_tipo_display }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if qp.pergunta.categoria %}
                            {{ qp.pergunta.categoria.nome }}
                            {% else %}
                            <em class="text-muted">Sem categoria</em>
                            {% endif %}
                        </td>
                        <td>
                            {% if qp.pergunta.obrigatoria %}
                            <span class="status-badge status-active">‚úì Obrigat√≥ria</span>
                            {% else %}
                            <span class="status-badge status-inactive">‚óã Opcional</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group">
                                <a href="?editar_pergunta={{ qp.pergunta.id }}" class="btn btn-sm btn-secondary"
                                    title="Editar Pergunta">
                                    ‚úèÔ∏è Editar
                                </a>
                                <form method="post" class="inline-form"
                                    onsubmit="return confirm('Tem certeza que deseja remover esta pergunta?')">
                                    {% csrf_token %}
                                    <input type="hidden" name="pergunta_id" value="{{ qp.pergunta.id }}">
                                    <button type="submit" name="remover_pergunta" class="btn btn-sm btn-danger"
                                        title="Remover Pergunta">
                                        üóëÔ∏è Remover
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state">
                <h3>üìù Nenhuma pergunta cadastrada</h3>
                <p>Adicione a primeira pergunta ao question√°rio usando o formul√°rio acima.</p>
            </div>
            {% endif %}
        </div>
    </div>
    </div>

    <script>
        // Mostrar/ocultar op√ß√µes m√∫ltipla escolha
        document.addEventListener('DOMContentLoaded', function () {
            const tipoSelect = document.getElementById('id_tipo');
            const opcoesContainer = document.getElementById('opcoes-container');

            function toggleOpcoes() {
                if (tipoSelect.value === 'multipla_escolha') {
                    opcoesContainer.style.display = 'block';
                } else {
                    opcoesContainer.style.display = 'none';
                }
            }

            // Verificar no carregamento
            toggleOpcoes();

            // Verificar quando mudar
            tipoSelect.addEventListener('change', toggleOpcoes);
        });

        // Fun√ß√µes de filtro
        function filterTable() {
            const searchText = document.getElementById('searchPerguntaTexto').value.toLowerCase();
            const filterTipo = document.getElementById('filterTipo').value;
            const filterObrigatoria = document.getElementById('filterObrigatoria').value;

            const table = document.querySelector('.data-table tbody');
            const rows = table.querySelectorAll('tr');
            let visibleCount = 0;

            rows.forEach(row => {
                const enunciado = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                const tipo = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                const obrigatoria = row.querySelector('td:nth-child(5)').textContent.toLowerCase();

                let showRow = true;

                // Filtro por texto do enunciado
                if (searchText && !enunciado.includes(searchText)) {
                    showRow = false;
                }

                // Filtro por tipo
                if (filterTipo) {
                    const tipoMap = {
                        'multipla_escolha': 'm√∫ltipla escolha',
                        'texto': 'texto livre',
                        'escala': 'escala'
                    };
                    if (!tipo.includes(tipoMap[filterTipo])) {
                        showRow = false;
                    }
                }

                // Filtro por obrigat√≥ria
                if (filterObrigatoria) {
                    if (filterObrigatoria === 'sim' && !obrigatoria.includes('obrigat√≥ria')) {
                        showRow = false;
                    }
                    if (filterObrigatoria === 'nao' && !obrigatoria.includes('opcional')) {
                        showRow = false;
                    }
                }

                if (showRow) {
                    visibleCount++;
                }

                row.style.display = showRow ? '' : 'none';
            });

            // Atualiza o contador
            const totalCount = document.getElementById('total-count');
            if (totalCount) {
                totalCount.textContent = visibleCount;
            }
        }

        function clearFilters() {
            document.getElementById('searchPerguntaTexto').value = '';
            document.getElementById('filterTipo').value = '';
            document.getElementById('filterObrigatoria').value = '';
            filterTable();
        }

        // Adicionar event listeners para filtros
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('searchPerguntaTexto').addEventListener('input', filterTable);
            document.getElementById('filterTipo').addEventListener('change', filterTable);
            document.getElementById('filterObrigatoria').addEventListener('change', filterTable);
        });
    </script>
</body>

</html>