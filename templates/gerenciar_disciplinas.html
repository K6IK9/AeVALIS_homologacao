{% load static %}

<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IF SADD - Gerenciar Disciplinas</title>

    <!-- CSS Global -->
    <link rel="stylesheet" href="{% static 'css/global.css' %}" />
    <!-- CSS de Gerenciamento -->
    <link rel="stylesheet" href="{% static 'css/gerenciar.css' %}" />
  </head>

  <body>
    <div class="container">
      <div class="header">
        <h1>Gerenciamento de Disciplinas</h1>
        <p>Crie e visualize as disciplinas do sistema</p>
      </div>

      <!-- Navega√ß√£o Breadcrumb -->
      <div class="nav-breadcrumb">
        <a href="{% url 'inicio' %}">üè† In√≠cio</a>
        <span>‚Üí</span>
        <a href="{% url 'admin_hub' %}">‚öôÔ∏è Administra√ß√£o</a>
        <span>‚Üí</span>
        <span>üìñ Disciplinas</span>
      </div>

      {% include "partials/messages.html" %}

      <div class="form-section">
        <h2>
          {% if editing %}Editar Disciplina{% else %}Criar Nova Disciplina{% endif %}
        </h2>
        <form method="post">
          {% csrf_token %}
          <div class="form-row">
            <div class="form-group">
              <label for="{{ form.disciplina_nome.id_for_label }}"
                >{{ form.disciplina_nome.label }}</label
              >
              {{ form.disciplina_nome }} {% if form.disciplina_nome.errors %}
              <div class="field-error">
                {% for error in form.disciplina_nome.errors %} {{ error }} {% endfor %}
              </div>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.disciplina_sigla.id_for_label }}">{{ form.disciplina_sigla.label }}</label>
              {{ form.disciplina_sigla }} {% if form.disciplina_sigla.errors %}
              <div class="field-error">
                {% for error in form.disciplina_sigla.errors %} {{ error }} {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="{{ form.disciplina_tipo.id_for_label }}">{{ form.disciplina_tipo.label }}</label>
              {{ form.disciplina_tipo }} {% if form.disciplina_tipo.errors %}
              <div class="field-error">
                {% for error in form.disciplina_tipo.errors %} {{ error }} {% endfor %}
              </div>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.curso.id_for_label }}">{{ form.curso.label }}</label>
              {{ form.curso }} {% if form.curso.errors %}
              <div class="field-error">
                {% for error in form.curso.errors %} {{ error }} {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="{{ form.professor.id_for_label }}">{{ form.professor.label }}</label>
              {{ form.professor }} {% if form.professor.errors %}
              <div class="field-error">
                {% for error in form.professor.errors %} {{ error }} {% endfor %}
              </div>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.periodo_letivo.id_for_label }}">{{ form.periodo_letivo.label }}</label>
              {{ form.periodo_letivo }} {% if form.periodo_letivo.errors %}
              <div class="field-error">
                {% for error in form.periodo_letivo.errors %} {{ error }} {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>

          <button type="submit" class="btn">
            {% if editing %}Atualizar Disciplina{% else %}Criar Disciplina{% endif %}
          </button>
          {% if editing %}
          <a href="{% url 'gerenciar_disciplinas' %}" class="btn btn-secondary">Cancelar</a>
          {% endif %}
        </form>
      </div>

      <!-- Se√ß√£o de Filtros -->
      {% if not editing %}
      <div class="filters-section" id="filtersSection">
        <div class="filter-row">
          <div class="filter-group">
            <label for="searchDisciplinaNome">Buscar por Nome ou Sigla:</label>
            <input type="text" id="searchDisciplinaNome" placeholder="Digite o nome ou sigla da disciplina">
          </div>
        </div>

        <div class="filter-row">
          <div class="filter-group">
            <label for="filterCurso">Curso:</label>
            <select id="filterCurso">
              <option value="">Todos os cursos</option>
              {% for curso in cursos %}
                <option value="{{ curso.curso_nome }}">{{ curso.curso_nome }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="filter-group">
            <label for="filterTipo">Tipo:</label>
            <select id="filterTipo">
              <option value="">Todos os tipos</option>
              <option value="Obrigat√≥ria">Obrigat√≥ria</option>
              <option value="Optativa">Optativa</option>
            </select>
          </div>
        </div>

        <div class="filter-row">
          <div class="filter-group">
            <label for="filterPeriodo">Per√≠odo Letivo:</label>
            <select id="filterPeriodo">
              <option value="">Todos os per√≠odos</option>
              {% for periodo in periodos %}
                <option value="{{ periodo.nome }}">{{ periodo.nome }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="filter-group">
            <button type="button" onclick="clearFiltersDisciplinas()" class="btn btn-clear">Limpar Filtros</button>
          </div>
        </div>
      </div>

      <!-- Lista de Disciplinas -->
      <div class="form-section">
        <div class="section-header">
          <h2 id="contador-disciplinas">üìö Disciplinas Cadastradas ({{ disciplinas.count }})</h2>
        </div>

        <div class="table-scroll-hint">
    <small>üí° Dica: Arraste a tabela lateralmente para ver mais colunas</small>
</div>
        <div class="table-responsive">
          <table class="data-table">
          <thead>
            <tr>
              <th>Nome da Disciplina</th>
              <th>Sigla</th>
              <th>Tipo</th>
              <th>Curso</th>
              <th>Professor</th>
              <th>Per√≠odo Letivo</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            {% for disciplina in disciplinas %}
            <tr>
              <td>{{ disciplina.disciplina_nome }}</td>
              <td>{{ disciplina.disciplina_sigla }}</td>
              <td>{{ disciplina.disciplina_tipo }}</td>
              <td>{{ disciplina.curso.curso_nome }}</td>
              <td>{{ disciplina.professor }}</td>
              <td>{{ disciplina.periodo_letivo }}</td>
              <td>
                <div class="btn-group">
                  <a href="{% url 'editar_disciplina' disciplina.id %}"
                     class="btn btn-sm btn-secondary" title="Editar Disciplina">
                    ‚úèÔ∏è Editar
                  </a>
                  <form method="post" action="{% url 'excluir_disciplina' disciplina.id %}" 
                        class="inline-form"
                        onsubmit="return confirm('Tem certeza que deseja excluir a disciplina \'{{ disciplina.disciplina_nome|escapejs }}\'?\n\nEsta a√ß√£o n√£o poder√° ser desfeita.')">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger" title="Excluir Disciplina">
                      üóëÔ∏è Excluir
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center-table">
                Nenhuma disciplina encontrada.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        </div>
      </div>
      {% endif %}

      <!-- Script global para funcionalidades de gerenciamento -->
      <script src="{% static 'js/gerenciar-global.js' %}"></script>

      <script>
        // Fun√ß√£o para filtrar a tabela de disciplinas (seguindo padr√£o dos usu√°rios)
        function filterTableDisciplinas() {
          const searchFilter = document.getElementById('searchDisciplinaNome').value.toLowerCase();
          const cursoFilter = document.getElementById('filterCurso').value.toLowerCase();
          const tipoFilter = document.getElementById('filterTipo').value.toLowerCase();
          const periodoFilter = document.getElementById('filterPeriodo').value.toLowerCase();
          
          const tableRows = document.querySelectorAll('.data-table tbody tr');
          let visibleCount = 0;

          tableRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            
            // Verifica se a linha tem c√©lulas (n√£o √© a linha "Nenhuma disciplina encontrada")
            if (cells.length > 1) {
              const disciplinaNome = cells[0].textContent.toLowerCase(); // Nome da disciplina
              const disciplinaSigla = cells[1].textContent.toLowerCase(); // Sigla
              const disciplinaTipo = cells[2].textContent.toLowerCase(); // Tipo
              const disciplinaCurso = cells[3].textContent.toLowerCase(); // Curso
              const disciplinaProfessor = cells[4].textContent.toLowerCase(); // Professor
              const disciplinaPeriodo = cells[5].textContent.toLowerCase(); // Per√≠odo Letivo

              // A busca procura em nome e sigla da disciplina
              const searchMatch = !searchFilter || 
                disciplinaNome.includes(searchFilter) || 
                disciplinaSigla.includes(searchFilter);
              
              const cursoMatch = !cursoFilter || disciplinaCurso.includes(cursoFilter);
              const tipoMatch = !tipoFilter || disciplinaTipo.includes(tipoFilter);
              const periodoMatch = !periodoFilter || disciplinaPeriodo.includes(periodoFilter);

              if (searchMatch && cursoMatch && tipoMatch && periodoMatch) {
                row.style.display = '';
                visibleCount++;
              } else {
                row.style.display = 'none';
              }
            }
          });

          // Atualiza o contador no t√≠tulo
          const sectionTitle = document.getElementById('contador-disciplinas');
          if (sectionTitle) {
            sectionTitle.textContent = `üìö Disciplinas Cadastradas (${visibleCount})`;
          }

          // Mostra mensagem se nenhum resultado for encontrado
          const emptyState = document.querySelector('.empty-state');
          if (emptyState) {
            emptyState.style.display = visibleCount === 0 ? 'block' : 'none';
          }
          
          // Se n√£o h√° resultados, mostra mensagem
          if (visibleCount === 0 && !emptyState) {
            // Se n√£o existe uma mensagem de empty state, cria uma tempor√°ria
            const tbody = document.querySelector('.data-table tbody');
            let noResultsRow = tbody.querySelector('.no-results-row');
            
            if (!noResultsRow) {
              noResultsRow = document.createElement('tr');
              noResultsRow.className = 'no-results-row';
              noResultsRow.innerHTML = '<td colspan="7" style="text-align: center; padding: 20px; color: #666;">Nenhuma disciplina encontrada com os filtros aplicados.</td>';
              tbody.appendChild(noResultsRow);
            }
            noResultsRow.style.display = '';
          } else {
            // Remove mensagem de "n√£o encontrado" se houver resultados
            const noResultsRow = document.querySelector('.no-results-row');
            if (noResultsRow) {
              noResultsRow.style.display = 'none';
            }
          }
        }

        // Fun√ß√£o para limpar filtros
        function clearFiltersDisciplinas() {
          document.getElementById('searchDisciplinaNome').value = '';
          document.getElementById('filterCurso').value = '';
          document.getElementById('filterTipo').value = '';
          document.getElementById('filterPeriodo').value = '';
          filterTableDisciplinas();
        }

        // Adiciona event listeners aos campos de filtro
        document.addEventListener('DOMContentLoaded', function() {
          const searchDisciplinaNome = document.getElementById('searchDisciplinaNome');
          const filterCurso = document.getElementById('filterCurso');
          const filterTipo = document.getElementById('filterTipo');
          const filterPeriodo = document.getElementById('filterPeriodo');

          if (searchDisciplinaNome) searchDisciplinaNome.addEventListener('input', filterTableDisciplinas);
          if (filterCurso) filterCurso.addEventListener('change', filterTableDisciplinas);
          if (filterTipo) filterTipo.addEventListener('change', filterTableDisciplinas);
          if (filterPeriodo) filterPeriodo.addEventListener('change', filterTableDisciplinas);
        });
      </script>
    </div>
  </body>
</html>
